"use client";

import { useState, useEffect } from 'react';

/**
 * LightingPanel.js
 * Îã®ÏàúÌôîÎêú Ï°∞Î™Ö Ï†úÏñ¥ Ìå®ÎÑê - ÏßÅÍ¥ÄÏ†ÅÏù¥Í≥† Ïâ¨Ïö¥ Ï°∞Î™Ö Ï°∞Ï†ï
 */

export default function LightingPanel({ 
  lightingSettings, 
  onLightingPreset, 
  onLightChange,
  onAdvancedLightChange // ÏÉàÎ°úÏö¥ 4Í∞ÄÏßÄ Ï°∞Î™Ö Ï†úÏñ¥Ïö© ÏΩúÎ∞±
}) {
  const [activeTab, setActiveTab] = useState('overall');
  const [mounted, setMounted] = useState(false);
  
  useEffect(() => { setMounted(true); }, []);

  // üéØ Í∞úÎ≥Ñ Ï°∞Î™Ö Ï†úÏñ¥ Ïª¥Ìè¨ÎÑåÌä∏
  const LightControl = ({ lightType, lightConfig, title, icon }) => {
    if (!lightConfig) return null;

    return (
      <div className="space-y-3">
        <div className="flex items-center justify-between">
          <h4 className="text-sm font-medium text-gray-300 flex items-center space-x-2">
            <span>{icon}</span>
            <span>{title}</span>
          </h4>
          <label className="relative inline-flex items-center cursor-pointer">
            <input
              type="checkbox"
              checked={lightConfig.enabled}
              onChange={(e) => onAdvancedLightChange(lightType, 'enabled', e.target.checked)}
              className="sr-only peer"
            />
            <div className="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
          </label>
        </div>

        {lightConfig.enabled && (
          <div className="space-y-2 pl-4">
            {/* Í∞ïÎèÑ Ï°∞Ï†à */}
            <div>
              <div className="flex items-center justify-between mb-1">
                <label className="text-xs text-gray-400">Í∞ïÎèÑ</label>
                <span className="text-xs text-gray-400">
                  {mounted ? lightConfig.intensity.toFixed(1) : ''}
                </span>
              </div>
              <input
                type="range"
                min="0"
                max="5"
                step="0.1"
                value={mounted ? lightConfig.intensity : 0}
                onChange={(e) => onAdvancedLightChange(lightType, 'intensity', parseFloat(e.target.value))}
                className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
              />
            </div>

            {/* ÏÉâÏÉÅ Ï°∞Ï†à (RGB Ïä¨ÎùºÏù¥Îçî) */}
            <div>
              <div className="flex items-center justify-between mb-1">
                <label className="text-xs text-gray-400">ÏÉâÏÉÅ</label>
                <div 
                  className="w-4 h-4 rounded border border-gray-600"
                  style={{ 
                    backgroundColor: `rgb(${Math.round(lightConfig.color[0] * 255)}, ${Math.round(lightConfig.color[1] * 255)}, ${Math.round(lightConfig.color[2] * 255)})` 
                  }}
                />
              </div>
              <div className="space-y-1">
                {['R', 'G', 'B'].map((channel, index) => (
                  <div key={channel} className="flex items-center space-x-2">
                    <span className="text-xs text-gray-500 w-3">{channel}</span>
                    <input
                      type="range"
                      min="0"
                      max="1"
                      step="0.01"
                      value={mounted ? lightConfig.color[index] : 0}
                      onChange={(e) => {
                        const newColor = [...lightConfig.color];
                        newColor[index] = parseFloat(e.target.value);
                        onAdvancedLightChange(lightType, 'color', newColor);
                      }}
                      className="flex-1 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                    />
                    <span className="text-xs text-gray-400 w-8">
                      {mounted ? Math.round(lightConfig.color[index] * 255) : 0}
                    </span>
                  </div>
                ))}
              </div>
            </div>

            {/* ÏúÑÏπò Ï°∞Ï†à (Spot LightÏôÄ Ambient LightÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞) */}
            {lightType !== 'spot' && lightType !== 'ambient' && (
              <div>
                <div className="flex items-center justify-between mb-1">
                  <label className="text-xs text-gray-400">ÏúÑÏπò</label>
                </div>
                <div className="space-y-1">
                  {['X', 'Y', 'Z'].map((axis, index) => (
                    <div key={axis} className="flex items-center space-x-2">
                      <span className="text-xs text-gray-500 w-3">{axis}</span>
                      <input
                        type="range"
                        min="-5"
                        max="5"
                        step="0.1"
                        value={mounted ? lightConfig.position[index] : 0}
                        onChange={(e) => {
                          const newPosition = [...lightConfig.position];
                          newPosition[index] = parseFloat(e.target.value);
                          onAdvancedLightChange(lightType, 'position', newPosition);
                        }}
                        className="flex-1 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                      />
                      <span className="text-xs text-gray-400 w-8">
                        {mounted ? lightConfig.position[index].toFixed(1) : 0}
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Spot Light Ï†ÑÏö© ÏÑ§Ï†ï */}
            {lightType === 'spot' && (
              <div className="space-y-2">
                <div>
                  <div className="flex items-center justify-between mb-1">
                    <label className="text-xs text-gray-400">Í∞ÅÎèÑ</label>
                    <span className="text-xs text-gray-400">
                      {mounted ? Math.round((lightConfig.angle * 180) / Math.PI) : 0}¬∞
                    </span>
                  </div>
                  <input
                    type="range"
                    min="0"
                    max="90"
                    step="1"
                    value={mounted ? (lightConfig.angle * 180) / Math.PI : 0}
                    onChange={(e) => onAdvancedLightChange(lightType, 'angle', (parseFloat(e.target.value) * Math.PI) / 180)}
                    className="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                  />
                </div>
                <div>
                  <div className="flex items-center justify-between mb-1">
                    <label className="text-xs text-gray-400">Î∂ÄÎìúÎü¨ÏõÄ</label>
                    <span className="text-xs text-gray-400">
                      {mounted ? lightConfig.penumbra.toFixed(1) : 0}
                    </span>
                  </div>
                  <input
                    type="range"
                    min="0"
                    max="1"
                    step="0.1"
                    value={mounted ? lightConfig.penumbra : 0}
                    onChange={(e) => onAdvancedLightChange(lightType, 'penumbra', parseFloat(e.target.value))}
                    className="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                  />
                </div>
              </div>
            )}
          </div>
        )}
      </div>
    );
  };

  // üéØ Ï†ÑÏ≤¥ Ï°∞Ï†ï Ïª¥Ìè¨ÎÑåÌä∏
  const OverallControl = ({ property, label, icon, min = 0, max = 3, step = 0.1 }) => {
    const value = lightingSettings?.overall?.[property] || 1;
    
    return (
      <div>
        <div className="flex items-center justify-between mb-1">
          <label className="text-sm text-gray-300 flex items-center space-x-1">
            <span>{icon}</span>
            <span>{label}</span>
          </label>
          <span className="text-xs text-gray-400">
            {mounted ? value.toFixed(1) : ''}
          </span>
        </div>
        <input
          type="range"
          min={min}
          max={max}
          step={step}
          value={mounted ? value : 1}
          onChange={(e) => onLightChange(property, parseFloat(e.target.value))}
          className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
        />
      </div>
    );
  };

  return (
    <div className="space-y-4">
      {/* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
      <div className="flex space-x-1 bg-gray-800 p-1 rounded-lg">
        {[
          { id: 'overall', label: 'Ï†ÑÏ≤¥', icon: 'üé®' },
          { id: 'directional', label: 'Ï£ºÍ¥ë', icon: '‚òÄÔ∏è' },
          { id: 'point', label: 'Ï†êÍ¥ë', icon: 'üí°' },
          { id: 'spot', label: 'Ïä§Ìåü', icon: 'üî¶' },
          { id: 'ambient', label: 'ÌôòÍ≤Ω', icon: 'üåÖ' }
        ].map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex-1 px-3 py-2 text-xs font-medium rounded-md transition-colors ${
              activeTab === tab.id
                ? 'bg-blue-600 text-white'
                : 'text-gray-400 hover:text-white hover:bg-gray-700'
            }`}
          >
            <span className="mr-1">{tab.icon}</span>
            {tab.label}
          </button>
        ))}
      </div>

      {/* ÌÉ≠ ÎÇ¥Ïö© */}
      <div className="space-y-4">
        {activeTab === 'overall' && (
          <div className="space-y-4">
            <h4 className="text-sm font-medium text-gray-300">üé® Ï†ÑÏ≤¥ Ï°∞Î™Ö Ï°∞Ï†ï</h4>
            <div className="space-y-3">
              <OverallControl 
                property="contrast" 
                label="ÎåÄÎπÑ" 
                icon="üîÜ" 
                min={0.5} 
                max={2.0} 
              />
              <OverallControl 
                property="brightness" 
                label="Î∞ùÍ∏∞" 
                icon="üí°" 
                min={0.3} 
                max={2.0} 
              />
              <OverallControl 
                property="warmth" 
                label="ÏÉâÏò®ÎèÑ" 
                icon="üå°Ô∏è" 
                min={0.5} 
                max={1.5} 
              />
              <OverallControl 
                property="exposure" 
                label="ÎÖ∏Ï∂ú" 
                icon="üì∏" 
                min={0.5} 
                max={2.0} 
              />
            </div>
          </div>
        )}

        {activeTab === 'directional' && (
          <LightControl 
            lightType="directional"
            lightConfig={lightingSettings?.directional}
            title="Î∞©Ìñ•Í¥ë (Ï£ºÍ¥ëÏõê)"
            icon="‚òÄÔ∏è"
          />
        )}

        {activeTab === 'point' && (
          <LightControl 
            lightType="point"
            lightConfig={lightingSettings?.point}
            title="Ï†êÍ¥ëÏõê"
            icon="üí°"
          />
        )}

        {activeTab === 'spot' && (
          <LightControl 
            lightType="spot"
            lightConfig={lightingSettings?.spot}
            title="Ïä§Ìåü Ï°∞Î™Ö"
            icon="üî¶"
          />
        )}

        {activeTab === 'ambient' && (
          <LightControl 
            lightType="ambient"
            lightConfig={lightingSettings?.ambient}
            title="ÌôòÍ≤ΩÍ¥ë"
            icon="üåÖ"
          />
        )}
      </div>

      {/* ÌîÑÎ¶¨ÏÖã Î≤ÑÌäºÎì§ */}
      <div className="pt-4 border-t border-gray-700">
        <h4 className="text-sm font-medium text-gray-300 mb-3">üé≠ Ï°∞Î™Ö ÌîÑÎ¶¨ÏÖã</h4>
        <div className="grid grid-cols-2 gap-2">
          {[
            { name: 'outdoor', label: 'ÏïºÏô∏', icon: 'üåû' },
            { name: 'indoor', label: 'Ïã§ÎÇ¥', icon: 'üè†' },
            { name: 'studio', label: 'Ïä§ÌäúÎîîÏò§', icon: 'üé¨' },
            { name: 'dramatic', label: 'ÎìúÎùºÎßàÌã±', icon: 'üé≠' }
          ].map(preset => (
            <button
              key={preset.name}
              onClick={() => onLightingPreset(preset.name)}
              className="flex items-center justify-center space-x-2 px-3 py-2 text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-md transition-colors"
            >
              <span>{preset.icon}</span>
              <span>{preset.label}</span>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}
