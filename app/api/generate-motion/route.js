import { NextResponse } from 'next/server';

const TEXT2MOTION_API_URL = 'https://api.text2motion.ai/api/generate';

// 마지막 요청 정보를 저장하는 캐시
let lastRequestCache = {
  prompt: null,
  timestamp: null,
  response: null,
  isProcessing: false  // API 호출 진행 중 여부
};

export async function POST(request) {
  try {
    const { prompt } = await request.json();

    if (!prompt) {
      return NextResponse.json(
        { error: '프롬프트가 필요합니다.' },
        { status: 400 }
      );
    }

    const currentTime = Date.now();

    // 동일한 프롬프트로 1초 이내에 재요청된 경우 캐시된 응답 반환 (3초 → 1초로 단축)
    if (lastRequestCache.prompt === prompt && 
        currentTime - lastRequestCache.timestamp < 1000) {
      console.log('중복 요청 감지: 캐시된 응답 반환');
      return NextResponse.json(lastRequestCache.response);
    }

    // 이미 처리 중인 동일한 요청이 있는 경우 대기
    if (lastRequestCache.isProcessing && lastRequestCache.prompt === prompt) {
      console.log('동일한 요청이 처리 중입니다. 대기 중...');
      return NextResponse.json(
        { error: '이전 요청이 처리 중입니다.' },
        { status: 429 }
      );
    }

    // 이전 캐시 정리 (새로운 요청이 들어오면)
    if (lastRequestCache.prompt !== prompt) {
      console.log('새로운 요청 - 이전 캐시 정리');
      lastRequestCache = {
        prompt: null,
        timestamp: null,
        response: null,
        isProcessing: false
      };
    }

    // API 호출 시작 표시
    lastRequestCache.isProcessing = true;
    lastRequestCache.prompt = prompt;
    lastRequestCache.timestamp = currentTime;

    console.log('Text2Motion API 요청:', {
      prompt,
      apiKey: process.env.TEXT2MOTION_API_KEY?.substring(0, 5) + '...',
      appId: process.env.TEXT2MOTION_APP_ID
    });

    const response = await fetch(TEXT2MOTION_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-apikey': process.env.TEXT2MOTION_API_KEY,
      },
      body: JSON.stringify({
        prompt,
        target_skeleton: {
          world_matrix: [100, 0, 0, 0, 0, 99.9999999999999, 4.3711388286738005e-06, 0, 0, -4.3711388286738005e-06, 99.9999999999999, 0, 0, 0, 0, 1],
          root: {
            name: 'Hips',
            matrix: [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1],
            children: [
              {
                name: 'Spine',
                matrix: [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0.107586972415447, -0.0119231110438704, 1],
                children: [
                  {
                    name: 'Spine1',
                    matrix: [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0.126286625862122, 4.50004394858539e-10, 1],
                    children: [
                      {
                        name: 'Spine2',
                        matrix: [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0.144327461719513, 3.14339554385867e-10, 1],
                        children: [
                          {
                            name: 'Neck',
                            matrix: [1, 0, 0, 0, 0, 0.9939151176460317, 0.11014871461841881, 0, 0, -0.11014871461841881, 0.9939151176460317, 0, 0, 0.162368446588516, 1.13957474567883e-08, 1],
                            children: [
                              {
                                name: 'Head',
                                matrix: [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0.0591683946549892, 0.0238593183457851, 1],
                                children: [
                                  {
                                    name: 'HeadTop_End',
                                    matrix: [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0.242230072617531, 0.0976779162883759, 1],
                                    children: []
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            name: 'LeftShoulder',
                            matrix: [-0.029947608871174758, 0.0002718355120812088, -0.9995514399547423, 0, 0.9658035323759568, -0.25764738390500863, -0.029006548620685968, 0, -0.25753968987375225, -0.966238981369627, 0.007453374399738033, 0, 0.0705082714557648, 0.143950521945953, -0.00207335967570543, 1],
                            children: [
                              {
                                name: 'LeftArm',
                                matrix: [0.9999987733309347, 0.0015663131015130275, 4.014862662975443e-10, 0, -0.0015398188640198026, 0.9830838074904606, -0.1831498235640227, 0, -0.00028687035047262287, 0.18314959889919136, 0.9830850134103208, 0, -2.22392229631829e-10, 0.142236158251762, -1.943339933419e-09, 1],
                                children: [
                                  {
                                    name: 'LeftForeArm',
                                    matrix: [0.9999156874569506, 0.012985298792628731, 9.940629097215242e-09, 0, -0.012946359591008453, 0.9969172850633722, -0.07738422823763776, 0, -0.0010048671923430575, 0.07737770364814832, 0.9970013447721954, 0, 3.90602758471026e-11, 0.292298674583435, 1.210723632461e-09, 1],
                                    children: [
                                      {
                                        name: 'LeftHand',
                                        matrix: [0.991447870995953, -0.05513468694869241, -0.1182847623890668, 0, 0.055167049301490446, 0.9984726225326455, -0.0030031077936730085, 0, 0.1182696723160051, -0.0035479966351708255, 0.9929751739185841, 0, 3.74981816431141e-11, 0.292730450630188, 5.6104452680894e-12, 1],
                                        children: [
                                          {
                                            name: 'LeftHandThumb1',
                                            matrix: [0.7956960500046291, 0.6056961367107477, 1.0637577846361879e-08, 0, -0.5433589031315195, 0.713804331764976, 0.44186479604054735, 0, 0.26763578313453695, -0.3515900817229031, 0.897081662437863, 0, -0.0287214647978544, 0.0263460483402014, 0.0188943520188332, 1],
                                            children: [
                                              {
                                                name: 'LeftHandThumb2',
                                                matrix: [1, 5.551114947965913e-17, -5.551114891097295e-17, 0, -5.564754503394766e-17, 0.9999969739248086, -0.0024601099576679417, 0, 5.5374417393450215e-17, 0.0024601099576679417, 0.9999969739248086, 0, -0.005516710691154, 0.0342085957527161, 5.39429820256565e-11, 1],
                                                children: [
                                                  {
                                                    name: 'LeftHandThumb3',
                                                    matrix: [1, -5.551115347166919e-17, -5.551115200786443e-17, 0, 5.860401456892136e-17, 0.99835340919542, 0.05736262057958904, 0, 5.223548251333661e-17, -0.05736262057958904, 0.99835340919542, 0, -0.00345714320428669, 0.0523918382823467, 2.66830973982835e-10, 1],
                                                    children: [
                                                      {
                                                        name: 'LeftHandThumb4',
                                                        matrix: [1, 5.55111506842227e-17, -5.55111517782929e-17, 0, -5.55111517782929e-17, 0.9999999999999998, -1.970901664094526e-08, 0, 5.55111506842227e-17, 1.970901664094526e-08, 0.9999999999999998, 0, -0.000521870038937777, 0.0510049909353256, 1.61728730407873e-09, 1],
                                                        children: []
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            name: 'LeftHandIndex1',
                                            matrix: [0.9984008195099559, 0.05653144039541397, -1.4833731978343293e-09, 0, -0.05653137827991149, 0.9983997225279553, 0.001482389055202848, 0, 8.380306555130005e-05, -0.0014800183638021514, 0.9999989012607928, 0, -0.0398862101137638, 0.0957013294100761, 0.000883691711351275, 1],
                                            children: [
                                              {
                                                name: 'LeftHandIndex2',
                                                matrix: [1, 1.734723507523458e-18, -8.673616921685707e-19, 0, -1.7242250547154698e-18, 0.999928466760018, 0.011960826206980578, 0, 8.880483732812365e-19, -0.011960826206980578, 0.999928466760018, 0, 5.68914174436941e-06, 0.0477963909506798, 1.30964388639354e-11, 1],
                                                children: [
                                                  {
                                                    name: 'LeftHandIndex3',
                                                    matrix: [1, 3.469447000950424e-18, 1.7347235169847398e-18, 0, -3.549656215654859e-18, 0.9988182776112791, 0.048600909208732945, 0, -1.5640552814547912e-18, -0.048600909208732945, 0.9988182776112791, 0, 4.08908363169758e-06, 0.0439524687826633, -6.983810751926e-11, 1],
                                                    children: [
                                                      {
                                                        name: 'LeftHandIndex4',
                                                        matrix: [1, 8.45677715678082e-18, 1.908195814205896e-17, 0, -8.456776733993061e-18, 0.9999999999999998, -2.2156413592711e-08, 0, -1.9081958329430803e-17, 2.2156413592711e-08, 0.9999999999999998, 0, -1.25803796890978e-06, 0.0398715175688267, -1.65445324107338e-10, 1],
                                                        children: []
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            name: 'LeftHandMiddle1',
                                            matrix: [0.9954805855672567, 0.09496527908803984, -1.2941486187811185e-09, 0, -0.09491761488802208, 0.9949809424587464, 0.03167918960185405, 0, 0.003008424211847163, -0.03153601809981392, 0.9994980885418271, 0, 0.00173672719392926, 0.0944287478923798, -0.00239750999026, 1],
                                            children: [
                                              {
                                                name: 'LeftHandMiddle2',
                                                matrix: [1, 6.93889383573534e-18, -1.7347234784824855e-18, 0, -7.072762549701929e-18, 0.9954368448172148, -0.09542268171774548, 0, 1.0646798232042136e-18, 0.09542268171774548, 0.9954368448172148, 0, -4.85463215227355e-06, 0.0529406517744064, -1.93961114530738e-11, 1],
                                                children: [
                                                  {
                                                    name: 'LeftHandMiddle3',
                                                    matrix: [1, 3.009265538105056e-34, 8.673617092454982e-19, 0, -1.8615796972958419e-19, 0.9766964123034472, 0.21462552655518768, 0, -8.471490689196508e-19, -0.21462552655518768, 0.9766964123034472, 0, 5.30422985320911e-05, 0.0533351078629494, -4.42813077872195e-11, 1],
                                                    children: [
                                                      {
                                                        name: 'LeftHandMiddle4',
                                                        matrix: [1, -1.3877787824869765e-17, 3.4694468837323993e-18, 0, 1.3877787790759155e-17, 1, 9.83171410950944e-09, 0, -3.4694470201748415e-18, -9.83171410950944e-09, 1, 0, 1.47053906403016e-05, 0.03703523427248, 3.00836411337713e-10, 1],
                                                        children: []
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            name: 'LeftHandRing1',
                                            matrix: [0.9994291325322447, 0.03378474512131636, -8.888978181992302e-10, 0, -0.033660303046399144, 0.9957478570442869, 0.08575073685251995, 0, 0.002897067782583346, -0.0857017845147535, 0.9963166217885955, 0, 0.0381494835019112, 0.0940756499767303, -0.000476453511510044, 1],
                                            children: [
                                              {
                                                name: 'LeftHandRing2',
                                                matrix: [1, -6.938893985738873e-18, 2.992397968943704e-17, 0, 1.056772384309471e-17, 0.9924029619489811, -0.12302991668260783, 0, -2.884295447722461e-17, 0.12302991668260783, 0.9924029619489811, 0, -1.74491233337903e-05, 0.0429742187261581, 1.72643413454132e-10, 1],
                                                children: [
                                                  {
                                                    name: 'LeftHandRing3',
                                                    matrix: [1, 1.3877787697605362e-17, -2.428612930728507e-17, 0, -1.0979649267971386e-17, 0.9933065232230578, 0.11550822884517592, 0, 2.5726569341097793e-17, -0.11550822884517592, 0.9933065232230578, 0, 2.6738814995042e-05, 0.0406473055481911, 3.26852503396147e-11, 1],
                                                    children: [
                                                      {
                                                        name: 'LeftHandRing4',
                                                        matrix: [1, 1.3183898413915514e-16, 9.540978775464883e-18, 0, -1.3183898420931964e-16, 1, 7.35401695095562e-09, 0, -9.540977805918758e-18, -7.35401695095562e-09, 1, 0, -9.28990539250663e-06, 0.0354266837239265, -8.73870906192842e-11, 1],
                                                        children: []
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            name: 'LeftHandPinky1',
                                            matrix: [0.9994291325322447, 0.03378474512131636, -8.888978181992302e-10, 0, -0.033660303046399144, 0.9957478570442869, 0.08575073685251995, 0, 0.002897067782583346, -0.0857017845147535, 0.9963166217885955, 0, 0.0381494835019112, 0.0940756499767303, -0.000476453511510044, 1],
                                            children: [
                                              {
                                                name: 'LeftHandPinky2',
                                                matrix: [1, -6.938893985738873e-18, 2.992397968943704e-17, 0, 1.056772384309471e-17, 0.9924029619489811, -0.12302991668260783, 0, -2.884295447722461e-17, 0.12302991668260783, 0.9924029619489811, 0, -1.74491233337903e-05, 0.0429742187261581, 1.72643413454132e-10, 1],
                                                children: [
                                                  {
                                                    name: 'LeftHandPinky3',
                                                    matrix: [1, 1.3877787697605362e-17, -2.428612930728507e-17, 0, -1.0979649267971386e-17, 0.9933065232230578, 0.11550822884517592, 0, 2.5726569341097793e-17, -0.11550822884517592, 0.9933065232230578, 0, 2.6738814995042e-05, 0.0406473055481911, 3.26852503396147e-11, 1],
                                                    children: [
                                                      {
                                                        name: 'LeftHandPinky4',
                                                        matrix: [1, 1.3183898413915514e-16, 9.540978775464883e-18, 0, -1.3183898420931964e-16, 1, 7.35401695095562e-09, 0, -9.540977805918758e-18, -7.35401695095562e-09, 1, 0, 5.70806423638714e-06, 0.0354266837239265, -6.08176217720136e-11, 1],
                                                        children: []
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                name: 'LeftUpLeg',
                matrix: [-0.9995686930583119, 0.029339366030198037, 0.0011882894383121205, 0, -0.02936341994460357, -0.9987498666374592, -0.04045091003914963, 0, -7.324685432838485e-11, -0.040468359922099385, 0.999180820350421, 0, 0.117102049291134, -0.0598404668271542, 0.00698971142992377, 1],
                children: [
                  {
                    name: 'LeftLeg',
                    matrix: [0.9999550846632846, 0.009477798210351591, 8.321257090771351e-11, 0, -0.009474809005953272, 0.9996397088685365, -0.02511335243598369, 0, -0.0002380193623439617, 0.025112224460550624, 0.9996846100393862, 0, 2.34387675934755e-10, 0.463325500488281, -2.29901458981274e-10, 1],
                    children: [
                      {
                        name: 'LeftFoot',
                        matrix: [0.9999999168153643, -1.7307722138348944e-09, 0.0004078838780730805, 0, -0.00035540864926594687, 0.4906625156055934, 0.8713496022271782, 0, -0.00020013482960715834, -0.8713496747097399, 0.4906624747893973, 0, 1.74984665646249e-10, 0.425308257341385, 2.35913760748829e-10, 1],
                        children: [
                          {
                            name: 'LeftToeBase',
                            matrix: [0.9896801574134575, -4.420715182806845e-11, -0.14329405567011144, 0, 0.07495131216555856, 0.8522961875715371, 0.5176615832058922, 0, 0.12212897770410587, -0.5230594745557811, 0.8435006250548012, 0, -8.05169245079312e-13, 0.202908679842949, -5.50102807750363e-09, 1],
                            children: [
                              {
                                name: 'LeftToe_End',
                                matrix: [1, -4.163336309021642e-17, 5.789639601312224e-16, 0, 4.163336375667038e-17, 1, -1.15111475906815e-09, 0, -5.789639600832975e-16, 1.15111475906815e-09, 1, 0, 1.10519414800447e-11, 0.0756773799657822, 1.12109939387484e-10, 1],
                                children: []
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
                          {
                            name: 'RightShoulder',
                            matrix: [0.029947608871174758, 0.0002718355120812088, 0.9995514399547423, 0, -0.9658035323759568, -0.25764738390500863, 0.029006548620685968, 0, 0.25753968987375225, -0.966238981369627, -0.007453374399738033, 0, -0.0705082714557648, 0.143950521945953, 0.00207335967570543, 1],
                            children: [
                              {
                                name: 'RightArm',
                                matrix: [0.9999987733309347, -0.0015663131015130275, -4.014862662975443e-10, 0, 0.0015398188640198026, 0.9830838074904606, 0.1831498235640227, 0, 0.00028687035047262287, 0.18314959889919136, 0.9830850134103208, 0, 2.22392229631829e-10, 0.142236158251762, 1.943339933419e-09, 1],
                                children: [
                                  {
                                    name: 'RightForeArm',
                                    matrix: [0.9999156874569506, -0.012985298792628731, -9.940629097215242e-09, 0, 0.012946359591008453, 0.9969172850633722, 0.07738422823763776, 0, 0.0010048671923430575, 0.07737770364814832, 0.9970013447721954, 0, -3.90602758471026e-11, 0.292298674583435, -1.210723632461e-09, 1],
                                    children: [
                                      {
                                        name: 'RightHand',
                                        matrix: [0.991447870995953, 0.05513468694869241, 0.1182847623890668, 0, -0.055167049301490446, 0.9984726225326455, 0.0030031077936730085, 0, -0.1182696723160051, -0.0035479966351708255, 0.9929751739185841, 0, -3.74981816431141e-11, 0.292730450630188, -5.6104452680894e-12, 1],
                                        children: [
                                          {
                                            name: 'RightHandThumb1',
                                            matrix: [0.7956960500046291, 0.6056961367107477, 1.0637577846361879e-08, 0, -0.5433589031315195, 0.713804331764976, 0.44186479604054735, 0, 0.26763578313453695, -0.3515900817229031, 0.897081662437863, 0, -0.0287214647978544, 0.0263460483402014, 0.0188943520188332, 1],
                                            children: [
                                              {
                                                name: 'RightHandThumb2',
                                                matrix: [1, 5.551114947965913e-17, -5.551114891097295e-17, 0, -5.564754503394766e-17, 0.9999969739248086, -0.0024601099576679417, 0, 5.5374417393450215e-17, 0.0024601099576679417, 0.9999969739248086, 0, -0.005516710691154, 0.0342085957527161, 5.39429820256565e-11, 1],
                                                children: [
                                                  {
                                                    name: 'RightHandThumb3',
                                                    matrix: [1, -5.551115347166919e-17, -5.551115200786443e-17, 0, 5.860401456892136e-17, 0.99835340919542, 0.05736262057958904, 0, 5.223548251333661e-17, -0.05736262057958904, 0.99835340919542, 0, -0.00345714320428669, 0.0523918382823467, 2.66830973982835e-10, 1],
                                                    children: [
                                                      {
                                                        name: 'RightHandThumb4',
                                                        matrix: [1, 5.55111506842227e-17, -5.55111517782929e-17, 0, -5.55111517782929e-17, 0.9999999999999998, -1.970901664094526e-08, 0, 5.55111506842227e-17, 1.970901664094526e-08, 0.9999999999999998, 0, -0.000521870038937777, 0.0510049909353256, 1.61728730407873e-09, 1],
                                                        children: []
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            name: 'RightHandIndex1',
                                            matrix: [0.9984008195099559, 0.05653144039541397, -1.4833731978343293e-09, 0, -0.05653137827991149, 0.9983997225279553, 0.001482389055202848, 0, 8.380306555130005e-05, -0.0014800183638021514, 0.9999989012607928, 0, -0.0398862101137638, 0.0957013294100761, 0.000883691711351275, 1],
                                            children: [
                                              {
                                                name: 'RightHandIndex2',
                                                matrix: [1, 1.734723507523458e-18, -8.673616921685707e-19, 0, -1.7242250547154698e-18, 0.999928466760018, 0.011960826206980578, 0, 8.880483732812365e-19, -0.011960826206980578, 0.999928466760018, 0, 5.68914174436941e-06, 0.0477963909506798, 1.30964388639354e-11, 1],
                                                children: [
                                                  {
                                                    name: 'RightHandIndex3',
                                                    matrix: [1, 3.469447000950424e-18, 1.7347235169847398e-18, 0, -3.549656215654859e-18, 0.9988182776112791, 0.048600909208732945, 0, -1.5640552814547912e-18, -0.048600909208732945, 0.9988182776112791, 0, 4.08908363169758e-06, 0.0439524687826633, -6.983810751926e-11, 1],
                                                    children: [
                                                      {
                                                        name: 'RightHandIndex4',
                                                        matrix: [1, 8.45677715678082e-18, 1.908195814205896e-17, 0, -8.456776733993061e-18, 0.9999999999999998, -2.2156413592711e-08, 0, -1.9081958329430803e-17, 2.2156413592711e-08, 0.9999999999999998, 0, -1.25803796890978e-06, 0.0398715175688267, -1.65445324107338e-10, 1],
                                                        children: []
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            name: 'RightHandMiddle1',
                                            matrix: [0.9954805855672567, 0.09496527908803984, -1.2941486187811185e-09, 0, -0.09491761488802208, 0.9949809424587464, 0.03167918960185405, 0, 0.003008424211847163, -0.03153601809981392, 0.9994980885418271, 0, 0.00173672719392926, 0.0944287478923798, -0.00239750999026, 1],
                                            children: [
                                              {
                                                name: 'RightHandMiddle2',
                                                matrix: [1, 6.93889383573534e-18, -1.7347234784824855e-18, 0, -7.072762549701929e-18, 0.9954368448172148, -0.09542268171774548, 0, 1.0646798232042136e-18, 0.09542268171774548, 0.9954368448172148, 0, -4.85463215227355e-06, 0.0529406517744064, -1.93961114530738e-11, 1],
                                                children: [
                                                  {
                                                    name: 'RightHandMiddle3',
                                                    matrix: [1, 3.009265538105056e-34, 8.673617092454982e-19, 0, -1.8615796972958419e-19, 0.9766964123034472, 0.21462552655518768, 0, -8.471490689196508e-19, -0.21462552655518768, 0.9766964123034472, 0, 5.30422985320911e-05, 0.0533351078629494, -4.42813077872195e-11, 1],
                                                    children: [
                                                      {
                                                        name: 'RightHandMiddle4',
                                                        matrix: [1, -1.3877787824869765e-17, 3.4694468837323993e-18, 0, 1.3877787790759155e-17, 1, 9.83171410950944e-09, 0, -3.4694470201748415e-18, -9.83171410950944e-09, 1, 0, 1.47053906403016e-05, 0.03703523427248, 3.00836411337713e-10, 1],
                                                        children: []
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            name: 'RightHandRing1',
                                            matrix: [0.9994291325322447, 0.03378474512131636, -8.888978181992302e-10, 0, -0.033660303046399144, 0.9957478570442869, 0.08575073685251995, 0, 0.002897067782583346, -0.0857017845147535, 0.9963166217885955, 0, 0.0381494835019112, 0.0940756499767303, -0.000476453511510044, 1],
                                            children: [
                                              {
                                                name: 'RightHandRing2',
                                                matrix: [1, -6.938893985738873e-18, 2.992397968943704e-17, 0, 1.056772384309471e-17, 0.9924029619489811, -0.12302991668260783, 0, -2.884295447722461e-17, 0.12302991668260783, 0.9924029619489811, 0, -1.74491233337903e-05, 0.0429742187261581, 1.72643413454132e-10, 1],
                                                children: [
                                                  {
                                                    name: 'RightHandRing3',
                                                    matrix: [1, 1.3877787697605362e-17, -2.428612930728507e-17, 0, -1.0979649267971386e-17, 0.9933065232230578, 0.11550822884517592, 0, 2.5726569341097793e-17, -0.11550822884517592, 0.9933065232230578, 0, 2.6738814995042e-05, 0.0406473055481911, 3.26852503396147e-11, 1],
                                                    children: [
                                                      {
                                                        name: 'RightHandRing4',
                                                        matrix: [1, 1.3183898413915514e-16, 9.540978775464883e-18, 0, -1.3183898420931964e-16, 1, 7.35401695095562e-09, 0, -9.540977805918758e-18, -7.35401695095562e-09, 1, 0, -9.28990539250663e-06, 0.0354266837239265, -8.73870906192842e-11, 1],
                                                        children: []
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            name: 'RightHandPinky1',
                                            matrix: [0.9994291325322447, 0.03378474512131636, -8.888978181992302e-10, 0, -0.033660303046399144, 0.9957478570442869, 0.08575073685251995, 0, 0.002897067782583346, -0.0857017845147535, 0.9963166217885955, 0, 0.0381494835019112, 0.0940756499767303, -0.000476453511510044, 1],
                                            children: [
                                              {
                                                name: 'RightHandPinky2',
                                                matrix: [1, -6.938893985738873e-18, 2.992397968943704e-17, 0, 1.056772384309471e-17, 0.9924029619489811, -0.12302991668260783, 0, -2.884295447722461e-17, 0.12302991668260783, 0.9924029619489811, 0, -1.74491233337903e-05, 0.0429742187261581, 1.72643413454132e-10, 1],
                                                children: [
                                                  {
                                                    name: 'RightHandPinky3',
                                                    matrix: [1, 1.3877787697605362e-17, -2.428612930728507e-17, 0, -1.0979649267971386e-17, 0.9933065232230578, 0.11550822884517592, 0, 2.5726569341097793e-17, -0.11550822884517592, 0.9933065232230578, 0, 2.6738814995042e-05, 0.0406473055481911, 3.26852503396147e-11, 1],
                                                    children: [
                                                      {
                                                        name: 'RightHandPinky4',
                                                        matrix: [1, 1.3183898413915514e-16, 9.540978775464883e-18, 0, -1.3183898420931964e-16, 1, 7.35401695095562e-09, 0, -9.540977805918758e-18, -7.35401695095562e-09, 1, 0, 5.70806423638714e-06, 0.0354266837239265, -6.08176217720136e-11, 1],
                                                        children: []
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          },
              {
                name: 'RightUpLeg',
                matrix: [-0.9995689686842679, -0.029326000541318776, -0.0013429413819412675, 0, 0.02935673345767133, -0.9985225418757833, -0.04572588493790828, 0, 6.432772153494581e-11, -0.045745601372264834, 0.9989531219852997, 0, -0.117102049291134, -0.0598404668271542, 0.00819591153413057, 1],
                children: [
                  {
                    name: 'RightLeg',
                    matrix: [0.9999551330082671, -0.009472695859915546, -9.540941120652052e-11, 0, 0.009470989651113872, 0.9997750226789698, -0.018979050672269387, 0, 0.00017978287725770546, 0.018978199138422327, 0.999819881589314, 0, -8.43054653865138e-11, 0.463431000709534, -8.3708978637631e-10, 1],
                    children: [
                      {
                        name: 'RightFoot',
                        matrix: [0.9999999563815436, 3.963324213834894e-10, -0.00029535896003626616, 0, 0.00025769674535626084, 0.4886367792276284, 0.8724872959197005, 0, 0.0001443236041216135, -0.8724873339761923, 0.4886367579139431, 0, -6.47327913494422e-10, 0.425284564495087, -2.86193824194925e-09, 1],
                        children: [
                          {
                            name: 'RightToeBase',
                            matrix: [0.9894166466222347, -8.927762973343079e-09, 0.14510237424737388, 0, -0.07548679130862589, 0.8540254001538392, 0.5147255142922109, 0, -0.12392111745038853, -0.520231305022538, 0.8449869469038356, 0, -3.82746265237266e-11, 0.203901320695877, 1.59822832745959e-09, 1],
                            children: [
                              {
                                name: 'RightToe_End',
                                matrix: [1, -1.3877787824901147e-17, -1.3487475025543868e-16, 0, 1.3877787790727774e-17, 1, -2.53371157388216e-10, 0, 1.3487475025895493e-16, 2.53371157388216e-10, 1, 0, -2.46967835071388e-10, 0.0751242190599442, 9.0652603479402e-11, 1],
                                children: []
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        }
      }),
      signal: AbortSignal.timeout(30000)
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({ error: 'API 응답 파싱 실패' }));
      console.error('Text2Motion API 에러:', {
        status: response.status,
        statusText: response.statusText,
        error
      });
      
      let errorMessage = 'Text2Motion API 호출 실패';
      if (error.detail) {
        errorMessage = Array.isArray(error.detail) 
          ? error.detail.map(err => err.msg).join(', ')
          : error.detail;
      } else if (error.error) {
        errorMessage = error.error;
      }
      
      // 에러 발생 시 캐시 초기화
      lastRequestCache.isProcessing = false;
      lastRequestCache.prompt = null;
      lastRequestCache.timestamp = null;
      lastRequestCache.response = null;
      
      return NextResponse.json(
        { error: errorMessage },
        { status: response.status }
      );
    }

    let data;
    try {
      data = await response.json();
      
      // 성공적인 응답을 캐시에 저장
      lastRequestCache = {
        prompt,
        timestamp: currentTime,
        response: data,
        isProcessing: false
      };
    } catch (e) {
      console.error('API 응답 파싱 에러:', e);
      // 파싱 에러 시 캐시 초기화
      lastRequestCache.isProcessing = false;
      lastRequestCache.prompt = null;
      lastRequestCache.timestamp = null;
      lastRequestCache.response = null;
      
      return NextResponse.json(
        { error: 'API 응답을 파싱할 수 없습니다.' },
        { status: 500 }
      );
    }

    console.log('Text2Motion API 응답:', {
      requestId: data.request_id,
      hasResult: !!data.result,
      resultLength: data.result?.length,
      timestamp: new Date().toISOString()
    });

    // 애니메이션 데이터 구조 로깅
    if (data.result) {
      try {
        const animationData = JSON.parse(data.result);
        const sampleBone = animationData.bones ? Object.entries(animationData.bones)[0] : null;
        
        console.log('애니메이션 데이터 구조:', {
          type: typeof animationData,
          keys: Object.keys(animationData),
          duration: animationData.duration,
          bonesType: typeof animationData.bones,
          bonesKeys: animationData.bones ? Object.keys(animationData.bones) : null,
          sampleBone: sampleBone ? {
            name: sampleBone[0],
            position: sampleBone[1].position,
            rotation: sampleBone[1].rotation
          } : null
        });

        // 모든 본의 첫 번째 프레임 데이터 로깅
        if (animationData.bones) {
          console.log('모든 본의 첫 번째 프레임 데이터:');
          Object.entries(animationData.bones).forEach(([boneName, boneData]) => {
            console.log(`${boneName}:`, {
              position: boneData.position,
              rotation: boneData.rotation
            });
          });
        }
      } catch (e) {
        console.error('애니메이션 데이터 파싱 실패:', e);
        console.log('원본 데이터:', data.result);
      }
    }

    // 응답 반환 후 캐시 정리 (반복 방지)
    setTimeout(() => {
      console.log('캐시 자동 정리 (5초 후)');
      lastRequestCache = {
        prompt: null,
        timestamp: null,
        response: null,
        isProcessing: false
      };
    }, 5000);

    return NextResponse.json(data);
  } catch (error) {
    console.error('모션 생성 에러:', {
      message: error.message,
      stack: error.stack,
      timestamp: new Date().toISOString()
    });
    return NextResponse.json(
      { error: '모션 생성 중 오류가 발생했습니다.' },
      { status: 500 }
    );
  }
} 